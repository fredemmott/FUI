# Copyright 2024 Fred Emmott <fred@fredemmott.com>
# SPDX-License-Identifier: MIT
param($InputFile, $OutputFile)

$Namespaces = @{
    p = "http://schemas.microsoft.com/winfx/2006/xaml/presentation";
    x = "http://schemas.microsoft.com/winfx/2006/xaml";
}
$CppNs = "FredEmmott::GUI::gui_detail::WinUI3Themes"

$Themes = Select-Xml `
  -Path $InputFile `
  -Namespace $Namespaces `
  -XPath "/p:ResourceDictionary/p:ResourceDictionary.ThemeDictionaries/p:ResourceDictionary"

function Get-Key($Color)
{
    return $Color.Attributes.ItemOf("Key", $Namespaces.x).Value -Replace 'Color', ''
}

$content = @"
// $( '@' )generated by: $( $( Get-Item $PSCommandPath ).Name ) $( $( Get-Item ${InputFile} ).Name )
#pragma once

#include <skia/core/SkColor.h>
"@


function Convert-Theme($Theme)
{
    $keys = @()
    $ThemeName = $Theme.Key
    $Colors = $Theme.Color | Sort-Object -Property { Get-Key($_) }

    Write-Output "`nnamespace ${CppNs}::${ThemeName}Theme {"
    foreach ($Color in $Colors)
    {
        $Key = Get-Key($Color)
        $value = $Color.InnerText -replace '#'
        if ($value.Length -eq 6)
        {
            # RGB -> ARGB
            $value = "ff${value}"
        }
        $keys += $Key
        Write-Output "`n  constexpr SkColor $Key { 0x$value };"
    }
    Write-Output "`n}"
    Write-Output ($keys -join ',')
}

$keys = @()
foreach ($Theme in $Themes)
{
    $Result = Convert-Theme $Theme.Node
    $content += $Result[0..($Result.Length - 2)]
    $keys += $Result[-1] -split ','
    echo "Generated WinUI3 theme: $( $Theme.Node.Key )"

}
$Keys = $keys | Sort-Object | Get-Unique

$content += @"

namespace ${CppNs} {

enum class Colors {
"@
foreach ($Key in $Keys)
{
    $content += "`n  $Key,"
}

$content += "`n};`n}`n"

$content += "`n#define FUI_WINUI_THEME_COLORS(X)"
foreach ($Key in $Keys)
{
    $content += " \`n  X($Key)"
}

($content -split "`r" -join "") `
  | Set-Content -Encoding utf8 "$OutputFile" -NoNewline
